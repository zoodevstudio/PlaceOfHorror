using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using System.Collections;
using System.Collections.Generic;

public class PanelManager : MonoBehaviour
{
	
	public Animator initiallyOpen;
	private int m_OpenParameterId;
	private Animator m_Open;
	private GameObject m_PreviouslySelected;
	
	public void OnEnable ()
	{
		m_OpenParameterId = Animator.StringToHash ("Open");
		
		if (initiallyOpen == null)
			return;
		
		OpenPanel (initiallyOpen);
	}

	public void OpenPanel (Animator anim)
	{

		if (m_Open == anim)
			return;
		
		anim.gameObject.SetActive (true);

		//print (anim.name);
		//phần vá
		if (anim.name == "QuitWindow") {
			anim.GetComponent<Exitgame> ().SetActive ();
		}

		var newPreviouslySelected = EventSystem.current.currentSelectedGameObject;
		
		anim.transform.SetAsLastSibling ();
		
		CloseCurrent ();
		
		m_PreviouslySelected = newPreviouslySelected;
		
		m_Open = anim;
		m_Open.SetBool (m_OpenParameterId, true);
		
		GameObject go = FindFirstEnabledSelectable (anim.gameObject);
		
		SetSelected (go);
	}
	
	static GameObject FindFirstEnabledSelectable (GameObject gameObject)
	{
		GameObject go = null;
		var selectables = gameObject.GetComponentsInChildren<Selectable> (true);
		foreach (var selectable in selectables) {
			if (selectable.IsActive () && selectable.IsInteractable ()) {
				go = selectable.gameObject;
				break;
			}
		}
		return go;
	}
	
	public void CloseCurrent ()
	{
		if (m_Open == null)
			return;
		
		m_Open.SetBool (m_OpenParameterId, false);
		SetSelected (m_PreviouslySelected);
		StartCoroutine (DisablePanelDeleyed (m_Open));
		m_Open = null;
	}
	
	IEnumerator DisablePanelDeleyed (Animator anim)
	{
		bool closedStateReached = false;
		bool wantToClose = true;
		while (!closedStateReached && wantToClose) {
			if (!anim.IsInTransition (0))
				closedStateReached = anim.GetCurrentAnimatorStateInfo (0).IsName ("Closed");
			
			wantToClose = !anim.GetBool (m_OpenParameterId);
			
			yield return new WaitForEndOfFrame ();
		}
		
		if (wantToClose)
			anim.gameObject.SetActive (false);
	}
	
	private void SetSelected (GameObject go)
	{
		EventSystem.current.SetSelectedGameObject (go);
		
		var standaloneInputModule = EventSystem.current.currentInputModule as StandaloneInputModule;
		if (standaloneInputModule != null && standaloneInputModule.inputMode == StandaloneInputModule.InputMode.Buttons)
			return;
		
		EventSystem.current.SetSelectedGameObject (null);
	}

	public void ChangeSceneFadeNewGame (string loadi)
	{
		CommonVariable.Instance.loadi = loadi;
		FadeScene.Instance.TransitionToScene (FadeScene.SceneName.Scene);
		CommonVariable.Instance.PlayTime = 0;
		CommonVariable.Instance.TempPlayTime = 0;
	}

	public void ChangeSceneFadeMenu ()
	{
		
		FadeScene.Instance.TransitionToScene (FadeScene.SceneName.Menu);
	}

	public void CloseAnimatorPlayer (Animator ani)
	{
		ani.gameObject.SetActive (false);
	}

	public void ExitGame ()
	{
		Application.Quit ();
	}	
}
